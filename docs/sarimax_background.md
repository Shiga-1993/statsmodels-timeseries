Prophetモデルと同様の粒度で、**SARIMAX (Seasonal AutoRegressive Integrated Moving Average with eXogenous regressors) モデル**の構造と構成要素、および数式表現を、提供されたソース情報に基づいてMarkdown形式でまとめる。

SARIMAXモデルは、古典的な統計的時系列モデルであるARIMAに**季節性**と**外生変数**を組み込んだ、包括的なモデル形式である。

---

## SARIMAX モデルの構造とコンポーネントの解説

**SARIMAX**は、**S**easonal **A**uto**R**egressive **I**ntegrated **M**oving **A**verage with e**X**ogenous regressorsの頭文字を取ったもので、時系列データが持つ**トレンド（非定常性）**、**自己相関**、**移動平均（誤差）**、**季節性**、および**外部要因**を線形的にモデル化する統計モデルである。

### 1. モデルのコア構造：構成要素 (Components)

SARIMAXモデルは、**非季節性**と**季節性**の2つのブロックを持ち、それぞれがAR（自己回帰）、I（和分）、MA（移動平均）の3つの要素で構成される。

SARIMAXモデルは、以下の**7つのパラメータ**（次数と周期）によって規定される。

| 構成要素 | 記号 | 役割 | パラメータ |
| :--- | :--- | :--- | :--- |
| **自己回帰 (AR)** | $p$ | 過去の自分自身の値への依存度をモデル化。 | $p$ |
| **和分 (I)** | $d$ | データが定常性を得るまでに必要な**階差操作**の回数。 | $d$ |
| **移動平均 (MA)** | $q$ | 過去のモデルの**予測誤差**への依存度をモデル化。 | $q$ |
| **季節性AR (SAR)** | $P$ | 季節周期 $m$ の倍数期間前における、過去の値への依存度。 | $P$ |
| **季節性I (Seasonal I)** | $D$ | 季節性を除去するために必要な**季節階差操作**の回数。 | $D$ |
| **季節性MA (SMA)** | $Q$ | 季節周期 $m$ の倍数期間前における、過去の予測誤差への依存度。 | $Q$ |
| **季節周期 (Period)** | $m$ | 季節変動の期間（例：月次データで12ヶ月周期なら$m=12$）。 | $m$ |

SARIMAXモデルは、$\text{SARIMAX}(p, d, q)(P, D, Q)_m$ の形式で表現される。

### 2. 数学的な「式の形」の表現

SARIMAモデルは、**ラグ演算子** $L$ を用いた多項式（演算子）の形式で表現される。

ラグ演算子 $L$ は、時系列を1期前にシフトする操作 $L X_t = X_{t-1}$ を定義する。

#### A. 演算子の定義

1.  **非季節性AR演算子** $\phi_p(L)$：過去の $p$ 個の値に依存する。
    $$\phi_p (L) = 1 - \sum_{i=1}^p \varphi_i L^i$$
2.  **非季節性MA演算子** $\theta_q(L)$：過去の $q$ 個の誤差に依存する。
    $$\theta_q (L) = 1 + \sum_{i=1}^q \theta_i L^i$$
3.  **非季節性差分演算子** $\nabla^d$：$d$ 回の階差操作を行う。
    $$\nabla^d = (1-L)^d$$
4.  **季節性AR演算子** $\tilde{\phi}_P(L^s)$：周期 $s$ の倍数の過去の値に依存する。
    $$\tilde{\phi}_P (L^s) = 1 - \sum_{i=1}^P \Phi_i L^{is}$$
5.  **季節性MA演算子** $\tilde{\theta}_Q(L^s)$：周期 $s$ の倍数の過去の誤差に依存する。
    $$\tilde{\theta}_Q (L^s) = 1 + \sum_{i=1}^Q \Theta_i L^{is}$$
6.  **季節性差分演算子** $\nabla_s^D$：$D$ 回の季節階差操作を行う。
    $$\nabla_s^D = (1-L^s)^D$$

#### B. SARIMAモデルの一般形（演算子形式）

SARIMAモデルは、これらの演算子を組み合わせて、以下の**差分系列** $Y_t$ の線形関係として定義される。

$$
\mathbf{\phi_p (L) \tilde{\phi}_P (L^s) \nabla^d \nabla_s^D X_t = A(t) + \theta_q (L) \tilde{\theta}_Q (L^s) \epsilon_t}
$$

ここで、
*   $X_t$: 時点 $t$ の観測値。
*   $\epsilon_t$: ホワイトノイズ（誤差項）。
*   $A(t)$: 決定論的トレンド項（切片 $c$ や線形トレンド $t$ など）を含む。

#### C. ARIMAX/SARIMAXへの外生変数 (Exogenous Regressors) の導入

SARIMAXは、SARIMAモデルに**外生変数**（$x_t$ や $u_t$ などで示される）を**線形回帰**として組み込むことで拡張される。

外生変数 $x_t$ が導入された場合、このモデルは**SARIMAエラーを持つ回帰モデル**として見なされる。

$$
\mathbf{Y_t = \beta^T x_t + U_t} \quad (\text{または } \beta_t x_t)
$$

ここで、
*   $Y_t$: 予測対象の時系列。
*   $x_t$: 外生説明変数（例: N225の変動、マーケティング費用）。
*   $\beta^T$: 外生変数にかかる回帰係数（重み）。
*   $U_t$: **SARIMAプロセスに従う誤差項**（残差）。

この $U_t$ が、上記Bで示したSARIMA方程式によってモデル化される。この構造により、SARIMAXモデルは、**線形トレンドと外生変数の影響を統計的に分離して捕捉**し、予測を行うことができる。

### 3. 最適化と次数決定 (Estimation and Order Selection)

Prophetが人間が解釈できる事前スケール（Prior Scale）を調整するのに対し、SARIMAXでは**次数 $(p, d, q)(P, D, Q)_m$** と**係数**が主要な調整要素となる。

#### A. 次数の決定（「式の形」の決定）

次数決定は、通常、専門知識または自動化された手法に依存する。

*   **定常性の確保 ($d, D$)**:
    *   まず、ADF検定などを用いて、時系列を定常化するために必要な非季節性差分 $d$ と季節性差分 $D$ の次数を決定する。この操作（差分）が**前処理**に相当する。
*   **AR/MA 次数 ($p, q, P, Q$) の特定**:
    *   定常化された系列に対し、**自己相関関数 (ACF)** と**偏自己相関関数 (PACF)** のコレログラムを分析し、AR項とMA項の次数を特定する。
    *   ACFがラグ $q$ の後でゼロになり、PACFがテールオフする場合、MA($q$)が示唆される。
    *   ACFがテールオフし、PACFがラグ $p$ の後でゼロになる場合、AR($p$)が示唆される。
*   **自動化**: $\text{AIC}$ (Akaike Information Criterion) や $\text{BIC}$ (Bayesian Information Criterion) などの評価基準を用いて、複数の候補モデルから最適な次数を自動的に選択することも一般的である（例: `auto_arima`関数）。

#### B. 係数（重み）の推定

*   **最適化手法**: SARIMAXモデルの係数 ($\varphi_i, \theta_i, \Phi_i, \Theta_i, \beta$) の推定は、通常、ガウス誤差を仮定した**最尤法 (Maximum Likelihood Estimation, MLE)** または**条件付き最大尤度推定 (Conditional MLE)** によって行われる。
*   **状態空間モデル**: `statsmodels`ライブラリでは、**状態空間モデル**と**カルマンフィルター**（Kalman Filter）を使用してモデルをフィッティングする。
*   **Stationarity/Invertibility**: フィッティング時には、ARパラメータの**定常性**（AR多項式の根が単位円の外側にあること）およびMAパラメータの**インバーティビリティ**（MA多項式の根が単位円の外側にあること）を強制することが可能である（デフォルトではTrue）。

SARIMAXは、Prophetのような人間的な解釈性や柔軟性（自動変化点検出など）には劣るものの、**統計的な厳密性**と、線形関係・周期性・外生変数の影響を**統一された数理モデル**で包括的に捉えられる点で強力なモデルである。
