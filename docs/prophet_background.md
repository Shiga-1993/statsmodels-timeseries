Prophetモデルの構造とコンポーネントの数式表現に関する説明を、Markdown形式で以下にまとめる。

---

## Prophet モデルの構造とコンポーネントの解説

Prophetは、Meta（旧Facebook）によって開発された時系列予測ライブラリであり、特に**ビジネス時系列データ**の予測のために設計されている。

Prophetの基本的なモデルは**加法モデル**（Decomposable Time Series Model）であり、時系列データ $y(t)$ を、トレンド、季節性、休日効果、および誤差項の4つの主要な独立したコンポーネントに分解する。

**基本モデル式:**
$$y(t) = g(t) + s(t) + h(t) + \epsilon_t$$
（$\epsilon_t$ は、通常、平均ゼロの正規分布 $N(0, \sigma^2)$ に従う誤差項である。）

Prophetの利点は、ARIMAモデルと異なり、**データの定常化（階差操作）が不要**であり、外れ値や欠損値に対して**堅牢**である点にある。

### 1. トレンド成分 $g(t)$ の式の形 (Trend/Growth)

$g(t)$ は、時系列の**非周期的な変化**（長期的な成長または衰退）をモデル化する。Prophetは、成長率が途中で変化することを許容する**区分的関数**（Piecewise function）を使用する。

#### 式の形: 区分的成長モデル

Prophetは主に以下の2つの成長モデルをサポートしている。

1.  **区分的ロジスティック成長モデル (Piecewise Logistic Growth)**
    市場飽和や物理的な上限（キャパシティ $C(t)$）がある場合に用いられる。

2.  **区分的線形トレンドモデル (Piecewise Linear Trend)**
    線形的な成長率をモデル化する。

これらのモデルは、**変化点（changepoints）** $s_j$ で成長率を調整できるように設計されている。成長率の調整量 $\delta$ に**スパース事前分布**（L1正則化に相当）を課すことで、モデルは自動的に変化点を検出する。

*   **「式の複雑さ」の決定**: 変化点 $s_j$ の位置や数（デフォルトでは最初の80%に25個）。
*   **「重み」の柔軟性の調整**: $\delta$ に適用される**`changepoint_prior_scale` ($\tau$)**によって、トレンドの変化の柔軟性（スムーズさ）を制御する。

### 2. 季節性成分 $s(t)$ の式の形 (Seasonality Component)

$s(t)$ は、年次、週次、日次などの**規則的な周期的な変化**をモデル化する。この周期的な性質を近似するために、**フーリエ級数 (Fourier series)** を使用する。

季節成分 $s(t)$ は、以下のように、周期性ベクトル $X(t)$ と、学習される**フーリエ係数** $\beta$ のドット積として表される。

$$s(t) = X(t)\beta$$

*   **「式の形」（構造の複雑さ）の決定**: **フーリエ次数 $N$** を設定することで、使用する三角関数の項の数（$2N$ 個のパラメータ）が固定され、季節パターンの複雑さが決まる。
*   **「重み」の柔軟性の調整**: 係数 $\beta$ には、**`seasonality_prior_scale` ($\sigma$)** に基づく事前分布 $Normal(0, \sigma)$ が適用され、季節性成分の**強さ**を制御する。
*   **モード**: 季節効果はトレンドに**加法的**に作用するか、**乗法的**に作用するかを選択できる。

### 3. 休日/イベント成分 $h(t)$ の式の形 (Holidays Component)

$h(t)$ は、**不定期に発生するイベントや休日**による時系列への影響をモデル化する。これは、イベントの発生を示す**指示関数**（Indicator function）を用いて線形的にモデルに組み込まれる。

$L$ 個の異なる休日がある場合、休日効果 $h(t)$ は以下のように表される。

$$h(t) = \sum_{i=1}^L \kappa_i \mathbf{1}(t \in D_i)$$

*   **$\mathbf{1}(t \in D_i)$**: 時点 $t$ が休日 $i$ の日付集合 $D_i$ に含まれる場合に 1、そうでない場合に 0 となる指示関数。
*   **$\kappa_i$**: 各休日 $i$ に対応する**影響度（重み）**を示す推定パラメータ。
*   **「重み」の柔軟性の調整**: $\kappa$ には、**`holidays_prior_scale` ($\nu$)** に基づく事前分布 $Normal(0, \nu)$ が適用され、休日効果の強さを制御する。
*   **時間ウィンドウ**: `lower_window` と `upper_window` パラメータを使用することで、休日の影響をその前後数日間にわたって延長できる。

Prophetの最適化は、これらの「式の形」（構造）をハイパーパラメータで決定した後、内部の係数（$\delta, \beta, \kappa$など）を、設定された正則化パラメータの制約下で**最大事後確率推定（MAP推定）**により高速に推定する、というプロセスで実行される。
